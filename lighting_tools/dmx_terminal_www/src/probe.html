<!DOCTYPE HTML>
<html>
  <head>
    <style>
      body {
        margin: 0px;
        padding: 0px;
      }
    </style>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

    <script type="text/javascript" src="js/lib/jquery-2.1.1.js"></script>
    <script type="text/javascript" src="js/lib/kinetic-v5.1.0.js"></script>
    <script type="text/javascript" src="js/lib/eventemitter2.js"></script>
    <script type="text/javascript" src="js/lib/tinycolor.js"></script>
    <script type="text/javascript" src="js/lib/SortedList.js"></script>
    <script type="text/javascript" src="js/lib/IntervalTree.js"></script>
    <script type="text/javascript" src="js/lib/roslib.js"></script>
    <script type="text/javascript" src="js/message_factory.js"></script>
    <script type="text/javascript" src="js/dmx.js"></script>
    <script type="text/javascript" src="js/ui.js"></script>
    <script type="text/javascript" src="js/ui-tilegrid.js"></script>
    <script type="text/javascript" src="js/ui-inputbar.js"></script>
    <script type="text/javascript" src="js/ui-polarinput.js"></script>
    <script type="text/javascript" src="js/ui-dmxmovercontrol.js"></script>
    <script type="text/javascript" src="js/ui-stage.js"></script>
  </head>


  <body style="overflow: hidden" bgcolor='black'>
    <center>
      <div id="tilegrid-0" class="stage"></div>
    </center>

    <script>
      $( document ).ready(function() {
        document.body.addEventListener('touchmove', function(event) {
          event.preventDefault();
        }, false);
      });
    </script>

<script>
var mover;
var f1;
var f2;
var f3;
var view;
var dmxClient;
var ros;

$( document ).ready(function(){
  ros=new ROSLIB.Ros({url : 'ws://' + window.location.hostname + ':4000'});
  ros.on('connection', function(){
    console.log('ros socket ready');

    Dmx.factory = new ROSUtils.MessageFactory(ros);
    Dmx.factory.getMessageDetails('lighting_msgs/DmxCommand',
      function(type){
        console.log("type: " + type + " ready");
        Dmx.emitter.emit('ready');
        init();
      }
    );


    //init();
  });
})

var init = function() {

  /*Dmx.emitter.on('change.Device.*', function(value){
    console.log(this.event);
    console.log(value);
  });*/

  dmxClient = new Dmx.CommandClient(ros);


  mover = new Dmx.Device({name:'mover-01', address: "1.496"});

  mover.template.addField(new Dmx.Field({ name: 'pan', offset: 2, bytes: 2}))
  mover.template.addField(new Dmx.Field({ name: 'tilt', offset: 4, bytes: 2}))
  mover.template.addField(new Dmx.Field({ name: 'mode', offset: 0, bytes: 1, defaultVal: 255}))
  mover.template.addField(new Dmx.Field({ name: 'intensity', offset: 1, bytes: 1}))
  mover.template.addField(new Dmx.Field({ name: 'zoom', offset: 13, bytes: 1}))
  mover.template.addField(new Dmx.Field({ name: 'wheel', offset: 7, bytes: 1}))
  mover.template.addField(new Dmx.Field({name: 'color', offset: 8, length: 1, bytes: 3, format: 'rgb'}))
  /*mover.template.addField(new Dmx.Field({ name: 'red', offset: 8, bytes: 1}))
  mover.template.addField(new Dmx.Field({ name: 'green', offset: 9, bytes: 1}))
  mover.template.addField(new Dmx.Field({ name: 'blue', offset: 10, bytes: 1}))*/
  mover.template.addField(new Dmx.Field({ name: 'white', offset: 11, bytes: 1}))
  mover.set('mode', [255]);
  blinder.set('color', [0,0,0])
  dmxClient.add(mover);

  let blinder = new Dmx.Device({name:'blinder-01', address: "1.399"})
  blinder.template.addField(new Dmx.Field({ name: 'fun', offset: 0, bytes: 1, defaultVal: 255}))
  blinder.template.addField(new Dmx.Field({ name: 'color', offset: 1, length: 1, bytes: 3, defaultVal: 0, format: 'rgb'}))
  blinder.template.addField(new Dmx.Field({ name: 'left-color', offset: 4, length: 1, bytes: 3, format: 'rgb'}))
  blinder.template.addField(new Dmx.Field({ name: 'center-color', offset: 7, length: 1, bytes: 3, format: 'rgb'}))
  blinder.template.addField(new Dmx.Field({ name: 'right-color', offset: 10, length: 1, bytes: 3, format:'rgb'}))
  blinder.set('color', [0,0,0])
  blinder.set('left-color', [0,0,0])
  blinder.set('center-color', [0,0,0])
  blinder.set('right-color', [0,0,0])
  dmxClient.add(blinder);

  pixels = new Dmx.Device({name:'pixels-01', address: "1.0"});
  dmxClient.add(pixels);

  pixels.template.addField(new Dmx.Field({name: 'kitchen', offset: 0, length: 1, bytes: 3, format: 'rbg'}))
  pixels.template.addField(new Dmx.Field({name: 'fridge', length: 8, bytes: 3, format: 'rbg', offset: pixels.getField('kitchen').nextOffset}))
  pixels.template.addField(new Dmx.Field({name: 'top', length: 36, bytes: 3, format: 'rbg', offset: pixels.getField('fridge').nextOffset}))
  pixels.template.addField(new Dmx.Field({name: 'window', length: 8, bytes: 3, format: 'rbg', offset: pixels.getField('top').nextOffset}))
  pixels.template.addField(new Dmx.Field({name: 'couch', length: 25, bytes: 3, format: 'rbg', offset: pixels.getField('window').nextOffset}))
  pixels.template.addField(new Dmx.Field({name: 'bottom', length: 20, bytes: 3, format: 'rbg', offset: pixels.getField('couch').nextOffset}))
  pixels.set('top', [20,20,20])
  pixels.set('kitchen', [0,00,40])
  pixels.set('fridge', [50,150,50])
  pixels.set('window', [0,10,0])
  pixels.set('couch', [80,0,80])
  pixels.set('bottom', [80,180,80])

  dmxClient.setDevice(pixels)
  dmxClient.send()


  Ui.emitter.on('select.TileGrid.pixels',
    function(evt){
      var v = 255* (evt.x + (evt.y * 32)) / (32*16);

      blinder.set('right-color', [v,v/2,v/2])
      blinder.set('center-color', [v,v,v])
      blinder.set('left-color', [v,v/2,v/2])
      //blinder.set('left-color', [v,0,0])
      //blinder.set('center-color', [0,v,0])
      //blinder.set('right-color', [0,0,v])

      pixels.set('top', [v,v,v])
      pixels.set('kitchen', [v,v,v])
      pixels.set('fridge', [v,v,v])
      pixels.set('bottom', [v,v,v])
      dmxClient.setDevice(pixels);
      dmxClient.setDevice(blinder);
      dmxClient.send()
    }
  );

  var stages = $(".stage");

  for(var i=0; i<stages.length; i++){
    var options = {
      container: stages[i],
      width: $( window ).width(),
      height: $( window ).height(),
      x: 0,
      y: 0,
      offsetX: 0,
      offsetY: 0,
      scaleX: 1,
      scaleY: 1
    };

    contain = options.container;
    console.log(options.container);
    view = new Ui.StageView( options );

    options.container=undefined;
    options.x=10;
    options.y=10;
    options.name = 'mover-1';
    options.width = view.stage.width();
    options.height = view.stage.height();
    options.tileSize = { x: 20, y :20 }
    options.tileCount = { x: 32, y: 16 };
    options.margins = {inner: {x:1, y:1}, outer: {x:10, y:5}};
    options.defaultTileOpt = {
      fill: 'grey'
    };

    titleLayer = new Kinetic.Layer(options);
    titleText = new Kinetic.Text({
      x: options.x,
      y: options.y,
      text: "DMX Probe",
      fontSize: 30,
      fontFamily: 'monospace',
      fill: '#B2E9E2'
    });

    options.y += 35;

    lineBreak = new Kinetic.Line({
      points: [ options.x, options.y,
                options.width - 20, options.y
              ],
      stroke: '#B2E9E2',
      strokeWidth: 1,
      dash: [5, 5]
    });

    options.y += 15;

    moverMargins = {inner: {x: 0, y: 10}, outer: {x:10, y:5}};
    var c = JSON.parse(JSON.stringify({name: options.name, x: options.x, y: options.y, margins: moverMargins, width: 200, height:300}));
    c.device = mover;
    view.mover1 = new Ui.DmxMoverControl(view.stage, c);

    options.x += view.mover1.layer.width();
    options.name = 'pixels';
    view.grid1 = new Ui.TileGrid(view.stage, JSON.parse(JSON.stringify(options)));


    titleLayer.add(titleText);
    titleLayer.add(lineBreak);
    view.stage.add(titleLayer);
    view.stage.add(view.grid1.layer);
    view.stage.add(view.mover1.layer);

    $( window ).resize(function() {
      view.stage.width( $( window ).width() );
      view.stage.height( $( window ).height() );
    });
    //views.push(view);
  }
}
</script>

  </body>
</html>
